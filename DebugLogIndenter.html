<!DOCTYPE html>
<html>

<head>

<title> sIndent </title>

<style>

tr {
	background-color: #eee;
}

input {
	margin-left: 2em;
}

button {
	margin-right: 2em;
}

</style>

<script type='text/javascript'>

var indent = 0;

var timeRegex          = /\d\d:\d\d:\d\d\.\d\d\d/i;
var microsecondsRegex  = /\(\d\d*\)/i;
var categoryRegex      = /\|[^|]*/i;
var subcategoryRegex   = /\|\[\w*\]/i;
var objectIdRegex      = /\|[A-Z0-9]{15}\|/i;

function indentLog() {

	var input = document.getElementById('input').value;
	var lines = input.split('\n');
	var output = '';
	var numOk = 0;

	var includeTime         = document.getElementById('includeTime').checked;
	var includeMicroseconds = document.getElementById('includeMicroseconds').checked;
	var includeCategory     = document.getElementById('includeCategory').checked;
	var includeSubcategory  = document.getElementById('includeSubcategory').checked;
	var includeObjectId     = document.getElementById('includeObjectId').checked;

	indent = 0;
	
	for (var i = 0; i < lines.length; i++) {
	
		var line = lines[i];

		if (timeRegex.test(line)) {
			output += indentLine(line, includeTime, includeMicroseconds, includeCategory, includeSubcategory, includeObjectId);
			++numOk;
		}
		
	}
	
	document.getElementById('output').innerHTML = output;
	
	if (indent !== 0)
	{
		alert('Error - indent not zero at end: ' + indent);
	}
	
	if (input && input.length > 0 && numOk === 0)
	{
		alert("Error - didn't understand the input.\n\nPaste a Salesforce Debug Log into the text-area.\n\nYou can paste a Ctrl-C copy of the whole Debug Log screen.");
	}
}

function indentLine(line, includeTime, includeMicroseconds, includeCategory, includeSubcategory, includeObjectId) {
	
	var output = '';

	var timeArray = timeRegex.exec(line);
	var microsecondsArray = microsecondsRegex.exec(line);
	var categoryArray = categoryRegex.exec(line);
	var subcategoryArray = subcategoryRegex.exec(line);
	var objectIdArray = objectIdRegex.exec(line);
	
	output += format(includeTime, timeArray);
	output += format(includeMicroseconds, microsecondsArray);
	output += format(includeObjectId, objectIdArray);
	output += format(includeSubcategory, subcategoryArray);
	output += format(includeCategory, categoryArray);
	
	line = line.replace(timeRegex, '');
	line = line.replace(microsecondsRegex, '');	
	line = line.replace(categoryRegex, '');
	line = line.replace(subcategoryRegex, '');	
	line = line.replace(objectIdRegex, '');

	var isEntry  = false;
	var isExit   = false;
	var rowStyle = '';
	
	if (categoryArray) {
		
		var category = categoryArray[0];
		
		if (/_ENTRY|_ENTER|DML_BEGIN|SOQL_EXECUTE_BEGIN/.test(category)) {
			isEntry = true;
		}		
		else if (/_EXIT|DML_END|SOQL_EXECUTE_END/.test(category)) {
			isExit = true;
		}
		else if (/EXCEPTION_THROWN|FATAL_ERROR/.test(category)) {
			rowStyle = 'background-color: #fdd;';
		}
		else if (/USER_DEBUG/.test(category)) {
			rowStyle = 'background-color: #dfd;';
		}		
	}

	if (isExit) {
		indent--;
	}

	var paddingLeft = indent * 30; 
	
	if (indent < 0) {
		line += " NEGATIVE INDENT ";
	}
	
	output += '<td style="padding-left:' + paddingLeft + 'px;">' + cleanUp(line) + '</td>';
	
	if (isEntry) {
		indent++;
	}		
	
	return '<tr style="' + rowStyle + '">' + output + '</tr>';
}

function format(include, resultsArray) {

	if (include) {
		
		if (resultsArray && resultsArray[0]) {
			var text = cleanUp(resultsArray[0]);
			return '<td>' + text + '</td>';
		}
		else {
			return '<td>&nbsp;</td>';
		}
		
	}

	return '';	
}

function cleanUp(text) {

	if (text === null || text === undefined) {
	    return '';
	}

	return text.replace(/\|/, '').replace(/\|$/, '');
}

</script>

</head>

<body>

<div style='font-family:monospace; font-weight:bold;'>

sIndent - Salesforce Debug Log Indenter - <span style='color:#ccc'> Andy Hutchinson </span>

</div>

<textarea id='input' autofocus required cols='100' rows='6' wrap='hard' oninput='indentLog()'
 placeholder='Paste your log here... (You can paste the full contents of the salesforce debug log screen from your browser - i.e. get it with Ctrl-A then Ctrl-C)'></textarea>

<div>
  <button onclick='indentLog()'>Indent</button>
  Include:
  <input id='includeTime' type='checkbox' onclick='indentLog()' checked>time</input>
  <input id='includeMicroseconds' type='checkbox' onclick='indentLog()'>microseconds</input>
  <input id='includeObjectId' type='checkbox' onclick='indentLog()'>objectId</input>
  <input id='includeSubcategory' type='checkbox' onclick='indentLog()'>subcategory</input>
  <input id='includeCategory' type='checkbox' onclick='indentLog()' checked>category</input>
</div>

<table id='output' style='font-family:monospace'></table>

</body>

</html>